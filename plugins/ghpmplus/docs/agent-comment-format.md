# Agent Comment Format Specification

This document defines the structured comment format that all GHPMplus agents use to document their reasoning in GitHub Issue/PR comments. The format uses YAML embedded in markdown, enabling both human readability and machine parseability.

## Purpose

- **Auditability:** Track agent decisions for review and debugging
- **Consistency:** Standardized format across all agents
- **Parseability:** Enable tooling to extract and analyze agent reasoning
- **Readability:** Renders cleanly in GitHub's markdown UI

## Format Overview

Agent comments follow this structure:

```markdown
## <Section Title>

```yaml
agent: <agent-identifier>
timestamp: <ISO 8601 timestamp>
decision_type: <type>
<additional fields...>
```

### <Subsection>

<Human-readable content>

---
*Generated by <agent-name>-agent*
```

## YAML Block Specification

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `agent` | string | Agent identifier (e.g., `epic-creator`, `task-creator`, `task-executor`) |
| `timestamp` | string | ISO 8601 timestamp (e.g., `2024-01-15T10:30:00Z`) |
| `decision_type` | string | Type of decision being documented |

### Decision Types

| Type | Used By | Description |
|------|---------|-------------|
| `epic_breakdown` | epic-creator | PRD → Epics decomposition |
| `task_breakdown` | task-creator | Epic → Tasks decomposition |
| `implementation` | task-executor | Task implementation decisions |
| `workflow_routing` | task-executor | TDD vs Non-TDD decision |
| `error_report` | all | Error or failure documentation |

### Optional Fields by Decision Type

#### epic_breakdown

```yaml
agent: epic-creator
timestamp: 2024-01-15T10:30:00Z
decision_type: epic_breakdown
prd_number: 42
epics_created: [101, 102, 103]
total_epics: 3
```

#### task_breakdown

```yaml
agent: task-creator
timestamp: 2024-01-15T11:00:00Z
decision_type: task_breakdown
epic_number: 101
tasks_created: [201, 202, 203, 204]
total_tasks: 4
total_points: 13
file_overlaps:
  - files: [models/user.rb]
    tasks: [201, 202]
```

#### implementation

```yaml
agent: task-executor
timestamp: 2024-01-15T12:00:00Z
decision_type: implementation
task_number: 201
workflow: TDD
commits:
  - sha: abc123
    message: "feat(auth): implement user model"
  - sha: def456
    message: "refactor(auth): extract validation"
pr_number: 150
```

#### workflow_routing

```yaml
agent: task-executor
timestamp: 2024-01-15T11:45:00Z
decision_type: workflow_routing
task_number: 201
commit_type: feat
target_files:
  - models/user.rb
  - spec/models/user_spec.rb
workflow_chosen: TDD
reasoning: "Code files with feat commit type route to TDD"
```

#### error_report

```yaml
agent: task-executor
timestamp: 2024-01-15T13:00:00Z
decision_type: error_report
task_number: 201
error_type: test_failure
error_message: "Expected 1, got 0"
recovery_action: manual_intervention_required
```

## Human-Readable Sections

After the YAML block, include human-readable documentation:

### For epic_breakdown

```markdown
### Epics Created

| Epic | Title | Scope Summary |
|------|-------|---------------|
| #101 | Authentication Infrastructure | User model, JWT, session |
| #102 | OAuth Integration | Google, GitHub providers |

### Reasoning

The PRD was broken down based on logical system boundaries...

### Alternatives Considered

- Single epic approach: Rejected due to size (>10 tasks)
- By feature: Rejected due to high coupling
```

### For task_breakdown

```markdown
### Tasks Created

| Task | Title | Type | Estimate | File Scope |
|------|-------|------|----------|------------|
| #201 | Create User model | `feat` | 3 | `models/user.rb` |
| #202 | Add password hashing | `feat` | 2 | `models/user.rb` |

### File Overlap Analysis

| File | Tasks |
|------|-------|
| `models/user.rb` | #201, #202 |

⚠️ Tasks #201 and #202 should be batched due to shared file.

### Reasoning

Tasks were scoped to be atomic and independently testable...
```

### For implementation

```markdown
### Key Decisions

1. **Chose bcrypt over argon2:** Better library support in Ruby
2. **Extracted TokenService:** Reusable for API auth later

### Alternatives Considered

- Inline token generation: Rejected for testability
- Database-stored tokens: Rejected for performance
```

## Parsing the Format

To extract YAML from agent comments:

```python
import re
import yaml

def extract_agent_yaml(comment_body: str) -> dict | None:
    """Extract YAML block from agent comment."""
    pattern = r'```yaml\n(.*?)\n```'
    match = re.search(pattern, comment_body, re.DOTALL)
    if match:
        return yaml.safe_load(match.group(1))
    return None

# Usage
comment = """
## Epic Breakdown

```yaml
agent: epic-creator
timestamp: 2024-01-15T10:30:00Z
decision_type: epic_breakdown
prd_number: 42
```

### Epics Created
...
"""

data = extract_agent_yaml(comment)
# {'agent': 'epic-creator', 'timestamp': '2024-01-15T10:30:00Z', ...}
```

```bash
# Shell extraction using grep/sed
YAML_CONTENT=$(echo "$COMMENT_BODY" | sed -n '/```yaml/,/```/p' | sed '1d;$d')
```

## Template for Agents

Use this template when generating comments:

```bash
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

gh issue comment "$ISSUE_NUMBER" --body "$(cat <<COMMENT_EOF
## <Section Title>

\`\`\`yaml
agent: <agent-id>
timestamp: $TIMESTAMP
decision_type: <type>
<additional_fields>
\`\`\`

### <Subsection 1>

<Content>

### <Subsection 2>

<Content>

---
*Generated by <agent-name>-agent*
COMMENT_EOF
)"
```

## Examples by Agent

### epic-creator-agent

```markdown
## Epic Breakdown

```yaml
agent: epic-creator
timestamp: 2024-01-15T10:30:00Z
decision_type: epic_breakdown
prd_number: 42
epics_created: [101, 102, 103, 104]
total_epics: 4
```

### Epics Created

| Epic | Title | Scope Summary |
|------|-------|---------------|
| #101 | Authentication Infrastructure | User model, passwords, sessions |
| #102 | OAuth Integration | Google, GitHub, Apple providers |
| #103 | Session Management | Token refresh, logout, multi-device |
| #104 | Security Hardening | Rate limiting, audit logs, 2FA |

### Reasoning

The PRD describes a comprehensive authentication system. I broke it down into four epics based on system boundaries:

1. **Infrastructure** (#101): Core building blocks that other features depend on
2. **OAuth** (#102): Third-party integrations that can be developed in parallel
3. **Sessions** (#103): Token lifecycle management, depends on #101
4. **Security** (#104): Hardening features, can be applied incrementally

### Dependencies Identified

```
#101 (Infrastructure) ─┬─► #103 (Sessions)
                       └─► #104 (Security)
#102 (OAuth) ──────────────► #103 (Sessions)
```

### Alternatives Considered

- **Single epic:** Rejected - too large (estimated 15+ tasks)
- **By provider:** Rejected - would duplicate infrastructure work
- **By layer (model/controller/view):** Rejected - doesn't align with product delivery

---
*Generated by epic-creator-agent*
```

### task-creator-agent

```markdown
## Task Breakdown

```yaml
agent: task-creator
timestamp: 2024-01-15T11:00:00Z
decision_type: task_breakdown
epic_number: 101
tasks_created: [201, 202, 203, 204, 205]
total_tasks: 5
total_points: 13
file_overlaps:
  - files: [app/models/user.rb]
    tasks: [201, 202]
```

### Tasks Created

| Task | Title | Type | Estimate | File Scope |
|------|-------|------|----------|------------|
| #201 | Create User model | `feat` | 3 | `app/models/user.rb` |
| #202 | Add password hashing | `feat` | 2 | `app/models/user.rb` |
| #203 | Create SessionsController | `feat` | 3 | `app/controllers/sessions_controller.rb` |
| #204 | Add authentication specs | `test` | 3 | `spec/models/user_spec.rb` |
| #205 | Document auth endpoints | `docs` | 2 | `docs/api/authentication.md` |

### File Overlap Analysis

| File | Tasks |
|------|-------|
| `app/models/user.rb` | #201, #202 |

⚠️ **Recommendation:** Batch tasks #201 and #202 into a single PR to avoid merge conflicts.

### Reasoning

Tasks were designed to be:
- **Atomic:** Each task delivers a complete, testable unit
- **Sequential where needed:** #202 depends on #201 (password hashing needs User model)
- **Parallel where possible:** #203, #204, #205 can run concurrently

### Alternatives Considered

- **Combined User + Password task:** Rejected - would be 5 points, better to separate
- **Integration test task:** Deferred to QA phase

---
*Generated by task-creator-agent*
```

### task-executor-agent

```markdown
## Implementation Complete

```yaml
agent: task-executor
timestamp: 2024-01-15T14:30:00Z
decision_type: implementation
task_number: 201
workflow: TDD
commits:
  - sha: a1b2c3d
    message: "feat(auth): create User model with email validation (#201)"
  - sha: e4f5g6h
    message: "test(auth): add User model specs (#201)"
pr_number: 150
```

### Key Decisions

1. **Used ActiveModel validations:** Standard Rails pattern, well-tested
2. **Email normalization:** Downcased and stripped whitespace for consistency
3. **Indexed email column:** Added unique index for fast lookups

### Implementation Summary

Created User model with:
- Email attribute with format validation
- Email normalization callbacks
- Database migration with unique index
- RSpec model specs covering edge cases

### Test Coverage

| Scenario | Status |
|----------|--------|
| Valid email formats | ✅ |
| Invalid email formats | ✅ |
| Email uniqueness | ✅ |
| Email normalization | ✅ |

### Alternatives Considered

- **Custom email regex:** Rejected - used URI::MailTo::EMAIL_REGEXP instead
- **Separate EmailValidator class:** Deferred - not needed for current scope

---
*Generated by task-executor-agent*
```

## Validation

Before posting a comment, verify:

1. **YAML is valid:** Parse with a YAML parser
2. **Required fields present:** agent, timestamp, decision_type
3. **Timestamp is ISO 8601:** Use `date -u +"%Y-%m-%dT%H:%M:%SZ"`
4. **Renders correctly:** Preview in markdown viewer

```bash
# Quick YAML validation
echo "$YAML_CONTENT" | python3 -c "import yaml, sys; yaml.safe_load(sys.stdin)"
```

## Best Practices

1. **Always include reasoning:** Document WHY, not just WHAT
2. **List alternatives:** Show decision-making process
3. **Use tables for lists:** Better readability than bullet lists
4. **Include file paths:** Enable traceability
5. **Add warnings:** Flag overlaps, dependencies, risks
6. **Sign comments:** Footer identifies the generating agent
